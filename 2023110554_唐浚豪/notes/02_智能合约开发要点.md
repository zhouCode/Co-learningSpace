# æ™ºèƒ½åˆçº¦å¼€å‘è¦ç‚¹

**å­¦ç”Ÿ**: å”æµšè±ª (2023110554)  
**å­¦ä¹ ç‰¹è‰²**: æ³¨é‡å®‰å…¨æ€§å’Œæœ€ä½³å®è·µ  
**é‡ç‚¹æ–¹å‘**: æ™ºèƒ½åˆçº¦å®‰å…¨æ¼æ´åˆ†æä¸é˜²æŠ¤  
**æ›´æ–°æ—¶é—´**: 2024å¹´12æœˆ19æ—¥

---

## ğŸ“‹ ç›®å½•

1. [æ™ºèƒ½åˆçº¦å®‰å…¨åŸºç¡€](#æ™ºèƒ½åˆçº¦å®‰å…¨åŸºç¡€)
2. [å¸¸è§å®‰å…¨æ¼æ´åˆ†æ](#å¸¸è§å®‰å…¨æ¼æ´åˆ†æ)
3. [é˜²å¾¡æ€§ç¼–ç¨‹å®è·µ](#é˜²å¾¡æ€§ç¼–ç¨‹å®è·µ)
4. [å®‰å…¨å¼€å‘å·¥å…·é“¾](#å®‰å…¨å¼€å‘å·¥å…·é“¾)
5. [ä»£ç å®¡è®¡æ–¹æ³•](#ä»£ç å®¡è®¡æ–¹æ³•)
6. [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)

---

## ğŸ”’ æ™ºèƒ½åˆçº¦å®‰å…¨åŸºç¡€

### å®‰å…¨å¨èƒæ¨¡å‹

æ™ºèƒ½åˆçº¦é¢ä¸´çš„ä¸»è¦å¨èƒï¼š

```
å¨èƒåˆ†ç±»:
â”œâ”€â”€ ä»£ç å±‚é¢å¨èƒ
â”‚   â”œâ”€â”€ é‡å…¥æ”»å‡» (Reentrancy)
â”‚   â”œâ”€â”€ æ•´æ•°æº¢å‡º/ä¸‹æº¢
â”‚   â”œâ”€â”€ è®¿é—®æ§åˆ¶ç¼ºé™·
â”‚   â””â”€â”€ é€»è¾‘é”™è¯¯
â”œâ”€â”€ åè®®å±‚é¢å¨èƒ
â”‚   â”œâ”€â”€ å‰ç½®äº¤æ˜“æ”»å‡» (Front-running)
â”‚   â”œâ”€â”€ æ—¶é—´æˆ³ä¾èµ–
â”‚   â””â”€â”€ åŒºå—é‡ç»„æ”»å‡»
â””â”€â”€ ç»æµå±‚é¢å¨èƒ
    â”œâ”€â”€ é—ªç”µè´·æ”»å‡»
    â”œâ”€â”€ ä»·æ ¼æ“çºµ
    â””â”€â”€ æ²»ç†æ”»å‡»
```

### å®‰å…¨è®¾è®¡åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™** (Principle of Least Privilege)
   - æ¯ä¸ªå‡½æ•°åªè·å¾—å®Œæˆä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™
   - ä½¿ç”¨é€‚å½“çš„è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦

2. **çºµæ·±é˜²å¾¡** (Defense in Depth)
   - å¤šå±‚å®‰å…¨æ£€æŸ¥
   - å†—ä½™çš„å®‰å…¨æœºåˆ¶

3. **å¤±è´¥å®‰å…¨** (Fail-Safe)
   - åœ¨ä¸ç¡®å®šæƒ…å†µä¸‹é€‰æ‹©å®‰å…¨çš„é»˜è®¤è¡Œä¸º
   - ä¼˜é›…çš„é”™è¯¯å¤„ç†

---

## âš ï¸ å¸¸è§å®‰å…¨æ¼æ´åˆ†æ

### 1. é‡å…¥æ”»å‡» (Reentrancy Attack)

**æ¼æ´åŸç†**:
```solidity
// æ˜“å—æ”»å‡»çš„ä»£ç 
function withdraw(uint256 amount) external {
    require(balances[msg.sender] >= amount, "Insufficient balance");
    
    // å±é™©ï¼šåœ¨çŠ¶æ€æ›´æ–°å‰è¿›è¡Œå¤–éƒ¨è°ƒç”¨
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success, "Transfer failed");
    
    balances[msg.sender] -= amount; // çŠ¶æ€æ›´æ–°å¤ªæ™š
}
```

**å®‰å…¨ä¿®å¤**:
```solidity
// ä½¿ç”¨ Checks-Effects-Interactions æ¨¡å¼
function withdraw(uint256 amount) external nonReentrant {
    require(balances[msg.sender] >= amount, "Insufficient balance");
    
    // å…ˆæ›´æ–°çŠ¶æ€
    balances[msg.sender] -= amount;
    
    // å†è¿›è¡Œå¤–éƒ¨äº¤äº’
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success, "Transfer failed");
}
```

### 2. æ•´æ•°æº¢å‡º/ä¸‹æº¢

**æ¼æ´ç¤ºä¾‹**:
```solidity
// Solidity < 0.8.0 ä¸­çš„é—®é¢˜
function unsafeAdd(uint256 a, uint256 b) external pure returns (uint256) {
    return a + b; // å¯èƒ½æº¢å‡º
}

function unsafeSub(uint256 a, uint256 b) external pure returns (uint256) {
    return a - b; // å¯èƒ½ä¸‹æº¢
}
```

**å®‰å…¨è§£å†³æ–¹æ¡ˆ**:
```solidity
// ä½¿ç”¨ SafeMath åº“ (Solidity < 0.8.0)
import "@openzeppelin/contracts/utils/math/SafeMath.sol";

using SafeMath for uint256;

function safeAdd(uint256 a, uint256 b) external pure returns (uint256) {
    return a.add(b); // è‡ªåŠ¨æ£€æŸ¥æº¢å‡º
}

// Solidity >= 0.8.0 å†…ç½®æº¢å‡ºæ£€æŸ¥
function modernAdd(uint256 a, uint256 b) external pure returns (uint256) {
    return a + b; // è‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸
}
```

### 3. è®¿é—®æ§åˆ¶ç¼ºé™·

**å¸¸è§é—®é¢˜**:
- ç¼ºå°‘æƒé™æ£€æŸ¥
- æƒé™è®¾è®¡è¿‡äºå®½æ¾
- é»˜è®¤å¯è§æ€§é—®é¢˜

**æœ€ä½³å®è·µ**:
```solidity
import "@openzeppelin/contracts/access/AccessControl.sol";

contract SecureContract is AccessControl {
    bytes32 public constant ADMIN_ROLE = keccak256("ADMIN_ROLE");
    bytes32 public constant OPERATOR_ROLE = keccak256("OPERATOR_ROLE");
    
    constructor() {
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(ADMIN_ROLE, msg.sender);
    }
    
    function adminFunction() external onlyRole(ADMIN_ROLE) {
        // åªæœ‰ç®¡ç†å‘˜å¯ä»¥è°ƒç”¨
    }
    
    function operatorFunction() external onlyRole(OPERATOR_ROLE) {
        // åªæœ‰æ“ä½œå‘˜å¯ä»¥è°ƒç”¨
    }
}
```

---

## ğŸ›¡ï¸ é˜²å¾¡æ€§ç¼–ç¨‹å®è·µ

### è¾“å…¥éªŒè¯

```solidity
function secureTransfer(address to, uint256 amount) external {
    // åœ°å€éªŒè¯
    require(to != address(0), "Invalid recipient address");
    require(to != address(this), "Cannot transfer to contract itself");
    
    // æ•°å€¼éªŒè¯
    require(amount > 0, "Amount must be positive");
    require(amount <= balances[msg.sender], "Insufficient balance");
    require(amount <= MAX_TRANSFER_AMOUNT, "Amount exceeds limit");
    
    // æ‰§è¡Œè½¬è´¦é€»è¾‘
    _transfer(msg.sender, to, amount);
}
```

### çŠ¶æ€æ£€æŸ¥

```solidity
enum ContractState { Active, Paused, Terminated }

ContractState public state = ContractState.Active;

modifier onlyWhenActive() {
    require(state == ContractState.Active, "Contract is not active");
    _;
}

modifier onlyWhenNotTerminated() {
    require(state != ContractState.Terminated, "Contract is terminated");
    _;
}
```

### é”™è¯¯å¤„ç†

```solidity
function safeExternalCall(address target, bytes calldata data) 
    external 
    returns (bool success, bytes memory returnData) 
{
    // æ£€æŸ¥ç›®æ ‡åœ°å€
    require(target != address(0), "Invalid target address");
    require(target.code.length > 0, "Target is not a contract");
    
    // å®‰å…¨çš„å¤–éƒ¨è°ƒç”¨
    try this.externalCall(target, data) returns (bytes memory result) {
        return (true, result);
    } catch Error(string memory reason) {
        emit CallFailed(target, reason);
        return (false, bytes(reason));
    } catch (bytes memory lowLevelData) {
        emit CallFailed(target, "Low-level call failed");
        return (false, lowLevelData);
    }
}
```

---

## ğŸ”§ å®‰å…¨å¼€å‘å·¥å…·é“¾

### é™æ€åˆ†æå·¥å…·

1. **Slither**
   ```bash
   # å®‰è£…
   pip3 install slither-analyzer
   
   # ä½¿ç”¨
   slither contracts/MyContract.sol
   ```

2. **MythX**
   ```bash
   # å®‰è£…
   npm install -g mythx-cli
   
   # åˆ†æ
   mythx analyze contracts/
   ```

3. **Solhint**
   ```bash
   # å®‰è£…
   npm install -g solhint
   
   # é…ç½® .solhint.json
   {
     "extends": "solhint:recommended",
     "rules": {
       "compiler-version": ["error", "^0.8.0"],
       "func-visibility": ["warn", {"ignoreConstructors": true}]
     }
   }
   ```

### åŠ¨æ€æµ‹è¯•å·¥å…·

1. **Echidna** (æ¨¡ç³Šæµ‹è¯•)
   ```yaml
   # echidna.yaml
   testMode: assertion
   testLimit: 50000
   seqLen: 100
   contractAddr: "0x00a329c0648769A73afAc7F9381E08FB43dBEA72"
   ```

2. **Manticore** (ç¬¦å·æ‰§è¡Œ)
   ```python
   from manticore.ethereum import ManticoreEVM
   
   m = ManticoreEVM()
   with open('contract.sol') as f:
       source_code = f.read()
   
   user_account = m.create_account(balance=1000)
   contract_account = m.solidity_create_contract(source_code, owner=user_account)
   ```

---

## ğŸ” ä»£ç å®¡è®¡æ–¹æ³•

### å®¡è®¡æ£€æŸ¥æ¸…å•

#### æ¶æ„å±‚é¢
- [ ] åˆçº¦è®¾è®¡æ˜¯å¦éµå¾ªæœ€ä½³å®è·µ
- [ ] æƒé™æ§åˆ¶æ˜¯å¦åˆç†
- [ ] å‡çº§æœºåˆ¶æ˜¯å¦å®‰å…¨
- [ ] ç´§æ€¥åœæ­¢æœºåˆ¶æ˜¯å¦å®Œå–„

#### ä»£ç å±‚é¢
- [ ] æ˜¯å¦å­˜åœ¨é‡å…¥æ”»å‡»é£é™©
- [ ] æ•´æ•°è¿ç®—æ˜¯å¦å®‰å…¨
- [ ] å¤–éƒ¨è°ƒç”¨æ˜¯å¦å®‰å…¨
- [ ] éšæœºæ•°ç”Ÿæˆæ˜¯å¦å¯é¢„æµ‹
- [ ] æ—¶é—´æˆ³ä¾èµ–æ˜¯å¦å­˜åœ¨

#### ä¸šåŠ¡é€»è¾‘
- [ ] ä¸šåŠ¡æµç¨‹æ˜¯å¦æ­£ç¡®
- [ ] è¾¹ç•Œæ¡ä»¶æ˜¯å¦å¤„ç†
- [ ] å¼‚å¸¸æƒ…å†µæ˜¯å¦è€ƒè™‘
- [ ] ç»æµæ¿€åŠ±æ˜¯å¦åˆç†

### å®¡è®¡æŠ¥å‘Šæ¨¡æ¿

```markdown
# æ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡æŠ¥å‘Š

## é¡¹ç›®æ¦‚è¿°
- é¡¹ç›®åç§°: [é¡¹ç›®å]
- åˆçº¦åœ°å€: [åœ°å€]
- å®¡è®¡æ—¶é—´: [æ—¥æœŸ]
- å®¡è®¡å‘˜: [å§“å]

## ä¸¥é‡æ€§åˆ†çº§
- ğŸ”´ Critical: å¯èƒ½å¯¼è‡´èµ„é‡‘æŸå¤±
- ğŸŸ  High: ä¸¥é‡åŠŸèƒ½ç¼ºé™·
- ğŸŸ¡ Medium: ä¸­ç­‰é£é™©é—®é¢˜
- ğŸŸ¢ Low: è½»å¾®é—®é¢˜
- ğŸ“ Informational: å»ºè®®æ”¹è¿›

## å‘ç°çš„é—®é¢˜

### ğŸ”´ Critical Issues
1. [é—®é¢˜æè¿°]
   - ä½ç½®: [æ–‡ä»¶:è¡Œå·]
   - å½±å“: [å…·ä½“å½±å“]
   - å»ºè®®: [ä¿®å¤å»ºè®®]

### ğŸŸ  High Issues
[ç±»ä¼¼æ ¼å¼]

## ä¿®å¤éªŒè¯
[éªŒè¯ä¿®å¤åçš„ç»“æœ]

## æ€»ä½“è¯„ä¼°
[æ•´ä½“å®‰å…¨æ€§è¯„ä»·]
```

---

## âœ… æœ€ä½³å®è·µæ€»ç»“

### å¼€å‘é˜¶æ®µ

1. **è®¾è®¡é˜¶æ®µ**
   - å¨èƒå»ºæ¨¡åˆ†æ
   - å®‰å…¨éœ€æ±‚å®šä¹‰
   - æ¶æ„å®‰å…¨å®¡æŸ¥

2. **ç¼–ç é˜¶æ®µ**
   - éµå¾ªå®‰å…¨ç¼–ç è§„èŒƒ
   - ä½¿ç”¨æˆç†Ÿçš„å®‰å…¨åº“
   - å®æ–½é˜²å¾¡æ€§ç¼–ç¨‹

3. **æµ‹è¯•é˜¶æ®µ**
   - å•å…ƒæµ‹è¯•è¦†ç›–
   - é›†æˆæµ‹è¯•éªŒè¯
   - å®‰å…¨æµ‹è¯•ä¸“é¡¹

### éƒ¨ç½²é˜¶æ®µ

1. **éƒ¨ç½²å‰**
   - ä»£ç å®¡è®¡
   - æµ‹è¯•ç½‘éªŒè¯
   - å®‰å…¨å·¥å…·æ‰«æ

2. **éƒ¨ç½²å**
   - ç›‘æ§å‘Šè­¦
   - åº”æ€¥å“åº”
   - å®šæœŸå®¡è®¡

### å®‰å…¨ç¼–ç è§„èŒƒ

```solidity
// âœ… å¥½çš„å®è·µ
contract SecureExample {
    using SafeMath for uint256;
    
    mapping(address => uint256) private balances;
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    
    modifier validAddress(address addr) {
        require(addr != address(0), "Invalid address");
        _;
    }
    
    function transfer(address to, uint256 amount) 
        external 
        validAddress(to) 
        nonReentrant 
    {
        require(amount > 0, "Amount must be positive");
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        balances[msg.sender] = balances[msg.sender].sub(amount);
        balances[to] = balances[to].add(amount);
        
        emit Transfer(msg.sender, to, amount);
    }
}
```

---

## ğŸ“š å­¦ä¹ èµ„æº

### æ¨èé˜…è¯»
- [ConsenSys Smart Contract Best Practices](https://consensys.github.io/smart-contract-best-practices/)
- [OpenZeppelin Security Guidelines](https://docs.openzeppelin.com/learn/)
- [Ethereum Smart Contract Security Best Practices](https://github.com/ConsenSys/smart-contract-best-practices)

### å®è·µå¹³å°
- [Ethernaut](https://ethernaut.openzeppelin.com/) - æ™ºèƒ½åˆçº¦å®‰å…¨æŒ‘æˆ˜
- [Damn Vulnerable DeFi](https://www.damnvulnerabledefi.xyz/) - DeFiå®‰å…¨æŒ‘æˆ˜
- [CryptoZombies](https://cryptozombies.io/) - æ™ºèƒ½åˆçº¦å¼€å‘æ•™ç¨‹

### å®‰å…¨å·¥å…·
- [Remix IDE](https://remix.ethereum.org/) - åœ¨çº¿å¼€å‘ç¯å¢ƒ
- [Hardhat](https://hardhat.org/) - å¼€å‘æ¡†æ¶
- [Foundry](https://getfoundry.sh/) - å¿«é€Ÿå¼€å‘å·¥å…·é“¾

---

## ğŸ’¡ ä¸ªäººå­¦ä¹ å¿ƒå¾—

ä½œä¸ºæ³¨é‡å®‰å…¨æ€§å’Œæœ€ä½³å®è·µçš„å¼€å‘è€…ï¼Œæˆ‘æ·±åˆ»è®¤è¯†åˆ°ï¼š

1. **å®‰å…¨æ˜¯è®¾è®¡å‡ºæ¥çš„ï¼Œä¸æ˜¯æµ‹è¯•å‡ºæ¥çš„**
   - ä»è®¾è®¡é˜¶æ®µå°±è¦è€ƒè™‘å®‰å…¨å› ç´ 
   - å®‰å…¨ä¸æ˜¯äº‹åè¡¥æ•‘ï¼Œè€Œæ˜¯å…¨ç¨‹è´¯ç©¿

2. **é˜²å¾¡æ€§ç¼–ç¨‹æ˜¯å¿…é¡»çš„**
   - å‡è®¾æ‰€æœ‰è¾“å…¥éƒ½æ˜¯æ¶æ„çš„
   - å‡è®¾æ‰€æœ‰å¤–éƒ¨è°ƒç”¨éƒ½ä¼šå¤±è´¥
   - å‡è®¾æ‰€æœ‰è¾¹ç•Œæ¡ä»¶éƒ½ä¼šå‘ç”Ÿ

3. **æŒç»­å­¦ä¹ å’Œæ”¹è¿›**
   - å…³æ³¨æœ€æ–°çš„å®‰å…¨æ¼æ´å’Œæ”»å‡»æ‰‹æ³•
   - å‚ä¸å®‰å…¨ç¤¾åŒºè®¨è®º
   - å®šæœŸæ›´æ–°çŸ¥è¯†ä½“ç³»

4. **å·¥å…·è¾…åŠ©ï¼Œäººå·¥å®¡æŸ¥**
   - å·¥å…·å¯ä»¥å‘ç°å¸¸è§é—®é¢˜
   - å¤æ‚çš„ä¸šåŠ¡é€»è¾‘éœ€è¦äººå·¥å®¡æŸ¥
   - ä¸¤è€…ç»“åˆæ‰èƒ½è¾¾åˆ°æœ€ä½³æ•ˆæœ

---

**å¤‡æ³¨**: æœ¬ç¬”è®°å°†æŒç»­æ›´æ–°ï¼Œè®°å½•å­¦ä¹ è¿‡ç¨‹ä¸­çš„æ–°å‘ç°å’Œæ·±å…¥ç†è§£ã€‚å®‰å…¨æ— å°äº‹ï¼Œæ¯ä¸€ä¸ªç»†èŠ‚éƒ½å¯èƒ½æˆä¸ºæ”»å‡»è€…çš„çªç ´å£ã€‚